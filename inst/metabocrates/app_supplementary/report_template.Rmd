---
title: "Report"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    keep_tex: true
header-includes:
  - \usepackage{floatrow}
  - \usepackage{graphicx}
  - \usepackage{caption}
params:
  dat: NULL
  filtering_threshold: NULL
  LOD_method: NULL
  LLOQ_method: NULL
  ULOQ_method: NULL
  LOD_type: NULL
  corr_threshold: NULL
  corr_heatmap_metabolites: "all"
  cv_threshold: NULL
  PCA_types: NULL
  PCA_threshold: 30
  PCA_variance_threshold: 80
  PCA_variance_max_num: 5
  PCA_variance_cum: TRUE
---

<style type="text/css">
   .main-container {max-width: 100%;}
   .row {display: flex;}
   .column {flex: 50%;}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

library(MetaboCrates)
library(dplyr)
library(kableExtra)
library(gridExtra)
library(ggplot2)
```

## Data summary

```{r}
m_num <- length(attr(params[["dat"]][["metabocrates_dat"]], "metabolites"))
s_num <- params[["dat"]][["metabocrates_dat"]] %>%
  filter(`sample type` == "Sample") %>%
  nrow()
sample_types <- pull(attr(params[["dat"]][["metabocrates_dat"]], "samples"),
                     `sample type`)
materials <- unique(pull(params[["dat"]][["metabocrates_dat"]], "material"))
op <- unique(pull(params[["dat"]][["metabocrates_dat"]], "op"))
pb_codes <- unique(pull(params[["dat"]][["metabocrates_dat"]],
                        "plate bar code"))

total_mv_count <-
  attr(params[["dat"]][["metabocrates_dat"]], "NA_info")[["counts"]] %>%
  select(n) %>%
  sum()
```
Loaded data contains `r m_num` compounds and `r s_num` samples.

Sample types (`r length(sample_types)`): `r paste0(sample_types, collapse = ", ")`.

Materials (`r length(materials)`): `r paste0(materials, collapse = ", ")`.

OP (`r length(op)`): `r paste0(op, collapse = ", ")`.

Plate bar codes (`r length(pb_codes)`): `r paste0(pb_codes, collapse = ", ")`.

Initial total missing values count is `r total_mv_count`.

```{r}
attr(params[["dat"]][["metabocrates_dat"]], "NA_info")[["counts"]] %>%
  kbl(booktabs = TRUE, caption = "Missing values counts") %>%
  kable_styling(latex_options = "hold_position")
```
```{r, out.height="50%", out.width="50%", fig.cap="A barplot of missing values counts"}
plot_mv_types(params[["dat"]][["metabocrates_dat"]])
```

```{r, results='asis'}
if(is.null(params[["dat"]][["metabocrates_dat_group"]]))
  params[["dat"]][["metabocrates_dat_group"]] <-
    params[["dat"]][["metabocrates_dat"]]

if(!is.null(attr(params[["dat"]][["metabocrates_dat_group"]], "group"))){
  lvls_count <- params[["dat"]][["metabocrates_dat_group"]] %>%
    filter(`sample type` == "Sample") %>%
    select(all_of(attr(params[["dat"]][["metabocrates_dat_group"]], "group"))) %>%
    summarise(across(attr(params[["dat"]][["metabocrates_dat_group"]], "group"),
              n_distinct)) %>%
    unlist()
  
  cat("## Grouping\n\n")
  cat("Grouping column is ",
      attr(params[["dat"]][["metabocrates_dat_group"]], "group"),
      ". It contains ",
      lvls_count,
      " unique levels.")
}
```

```{r, out.height="50%", out.width="50%", eval=!is.null(attr(params[["dat"]][["metabocrates_dat_group"]], "group")), fig.cap="The counts of elements in each level of the selected grouping column", fig.pos="h"}
plot_groups(params[["dat"]][["metabocrates_dat_group"]])
```

## Compounds filtering

Missing values threshold was set to `r params[["filtering_threshold"]]`%.

```{r, results='asis'}
if(is.null(attr(params[["dat"]][["metabocrates_dat_group"]], "removed")[["LOD"]])){
  cat("No metabolite was removed based on the missing values ratio.")
}else{
  cat("Metabolites removed based on the missing values ratio: ",
      paste0(attr(params[["dat"]][["metabocrates_dat_group"]], "removed")[["LOD"]], collapse = ", "),
      ".")
}
```

```{r, out.height="50%", fig.cap="Barplots missing values ratios in each metabolite (up to 10 metabolites wiht the highest ratios are visible). First plot shows only total ratios and second plot includes the division by missing values types.", fig.pos="h"}
NA_perc_plt <- plot_NA_percent(params[["dat"]][["metabocrates_dat_group"]],
                               interactive = FALSE)

y_levels <- ggplot_build(NA_perc_plt)$layout$panel_params[[1]]$y$breaks
cropped_lvls <- y_levels[(max(length(y_levels)-10, 1)):length(y_levels)]

NA_perc_plt_crop <- NA_perc_plt +
  ylim(cropped_lvls)

NA_perc_type_plt_crop <-
  plot_NA_percent(params[["dat"]][["metabocrates_dat_group"]],
                  type = "NA_type",
                  interactive = FALSE) +
  ylim(cropped_lvls)

grid.arrange(NA_perc_plt_crop, NA_perc_type_plt_crop, nrow = 1)
```

```{r, out.height="30%", out.width="50%", eval=!is.null(params[["filtering_threshold"]]), fig.cap="Venn diagram of metabolites with missing values ratio greater than threshold in any group", fig.pos="h"}
if(lvls_count < 5)
  create_venn_diagram(params[["dat"]][["metabocrates_dat_group"]], params[["filtering_threshold"]])
```

## Gaps completing

```{r, results='asis'}
if(!is.null(attr(params[["dat"]][["metabocrates_dat_group"]], "completed"))){
  cat("Data was completed using the following methods:\n\n")
  cat("* LOD method: ", params[["LOD_method"]], ",\n")
  cat("* LOD type: ", params[["LOD_type"]], ",\n")
  cat("* LLOQ method: ", params[["LLOQ_method"]], ",\n")
  cat("* ULOQ method: ", params[["ULOQ_method"]], ".\n")
}else{
  cat("Imputation was not performed on the data.")
}
```

```{r, out.height="50%", out.width="50%", fig.cap="Heatmap of missing values for each plate bar code (up to 10 first metabolites from the dataset are visible).", fig.pos="h"}
aval_pb_codes <- params[["dat"]][["metabocrates_dat_group"]] %>%
        filter(`sample type` == "Sample") %>%
        select(`plate bar code`) %>%
        unlist() %>%
        unique()

heatmap_plts <- lapply(aval_pb_codes, function(pb_code){
 plot_heatmap(params[["dat"]][["metabocrates_dat_group"]], pb_code,
              include_title = TRUE) 
})

grid.arrange(grobs = heatmap_plts, ncol = min(length(heatmap_plts), 2))
```

```{r, results="asis", eval=!is.null(attr(params[["dat"]][["metabocrates_dat_group"]], "completed"))}
cat("The absolute correlation threshold for correlation heatmap was set to ",
    params[["corr_threshold"]], ".")
cat("There were ",
    length(params[["corr_heatmap_metabolites"]]),
    " metabolites chosen to be visible: ",
    paste0(params[["corr_heatmap_metabolites"]], collapse = ", "),
    ".")
```

```{r, eval=!is.null(attr(params[["dat"]][["metabocrates_dat_group"]], "completed")), out.height="50%", out.width="50%", fig.cap="Correlations heatmap (up to 10 chosen metabolites visible)."}
print(params[["corr_threshold"]])
print(params[["corr_heatmap_metabolites"]])

create_correlations_heatmap(
  params[["dat"]][["metabocrates_dat_group"]],
  threshold = params[["corr_threshold"]],
  metabolites_to_display =
    params[["corr_heatmap_metabolites"]][1:min(length(params[["corr_heatmap_metabolites"]]), 10)],
  interactive = FALSE
)
```

```{r, eval=!is.null(params[["qc_threshold"]])}
cat("## Quality control\n\n")
cat("CV threshold was set to ",
    qc_threshold,
    ".\n")
if(!is.null(attr(params[["dat"]][["metabocrates_dat_group"]], "removed")[["QC"]])){
  cat("Metabolites removed based on the CV: ",
      paste0(attr(params[["dat"]][["metabocrates_dat_group"]], "removed")[["QC"]],
             collapse = ", "),
      ".")
}else cat("No metabolites were removed based on the CV.")

pca_fig_cap <- paste0("PCA plot",
                      ifelse(is.null(attr(params[["dat"]][["metabocrates_dat_group"]], "group")),
                             " ",
                             "s "),
                      "with colors indicating sample type",
                      ifelse(is.null(attr(params[["dat"]][["metabocrates_dat_group"]], "group")),
                             ".",
                             " on the first one and group levels on the second."))
```

```{r, eval=!is.null(params[["qc_threshold"]]), out.height="50%", out.width="50%", fig.cap=pca_fig_cap}
create_PCA_plot(params[["dat"]][["metabocrates_dat_group"]],
                type = "sample type",
                types_to_display = ifelse(is.null(params[["PCA_types"]]),
                                          "all",
                                          params[["PCA_types"]]))

if(!is.null(attr(params[["dat"]][["metabocrates_dat_group"]], "group")))
  create_PCA_plot(params[["dat"]][["metabocrates_dat_group"]],
                  type = "group")
```

```{r, eval=!is.null(params[["qc_threshold"]])}
cat("Biplot threshold was set to ",
    params[["PCA_threshold"]],
    "%.\n")
cat("The cumulative PCA variance threhold was set to ",
    params[["PCA_variance_threshold"]],
    "%.")
cat("The maximum number of visible principal components was set to ",
    params[["PCA_variance_max_num"]],
    ".\n")
```

```{r, eval=!is.null(params[["qc_threshold"]]), out.height="50%", out.width="50%", fig.cap=pca_fig_cap}
create_PCA_plot(params[["dat"]][["metabocrates_dat_group"]],
                type = "biplot",
                types_to_display = ifelse(is.null(params[["PCA_types"]]),
                                          "all",
                                          params[["PCA_types"]]))
pca_variance(params[["dat"]][["metabocrates_dat_group"]],
             threshold = params[["PCA_variance_threshold"]],
             max_num = params[["PCA_variance_max_num"]],
             cumulative = params[["PCA_variance_cum"]])
```






