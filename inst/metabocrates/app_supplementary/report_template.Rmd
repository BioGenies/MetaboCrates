---
title: "Report"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    keep_tex: true
header-includes:
  - \usepackage{graphicx}
  - \usepackage{caption}
  - \usepackage{float}
params:
  dat: NULL
  filtering_threshold: NULL
  LOD_method: NULL
  LLOQ_method: NULL
  ULOQ_method: NULL
  LOD_type: NULL
  corr_threshold: NULL
  corr_heatmap_metabolites: "all"
  cv_threshold: NULL
  PCA_types: "all"
  PCA_threshold: NULL
  PCA_variance_threshold: NULL
  PCA_variance_max_num: NULL
  PCA_variance_cum: TRUE
  filtering_threshold_ex: FALSE
---

<style type="text/css">
   .main-container {max-width: 100%;}
   .row {display: flex;}
   .column {flex: 50%;}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

library(MetaboCrates)
library(dplyr)
library(ggpubr)
library(ggplot2)
```

## Data summary

```{r}
m_num <- length(attr(params[["dat"]], "metabolites"))
s_num <- params[["dat"]] %>%
  filter(`sample type` == "Sample") %>%
  nrow()
sample_types <- pull(attr(params[["dat"]], "samples"),
                     `sample type`)
materials <- unique(pull(params[["dat"]], "material"))
op <- unique(pull(params[["dat"]], "op"))
pb_codes <- unique(pull(params[["dat"]],
                        "plate bar code"))

total_mv_count <-
  attr(params[["dat"]], "NA_info")[["counts"]] %>%
  select(n) %>%
  sum()
```
Dataset contains `r m_num` compounds and `r s_num` samples.

Sample types (`r length(sample_types)`): `r paste0(sample_types, collapse = ", ")`.

Materials (`r length(materials)`): `r paste0(materials, collapse = ", ")`.

OP (`r length(op)`): `r paste0(op, collapse = ", ")`.

Plate bar codes (`r length(pb_codes)`): `r paste0(pb_codes, collapse = ", ")`.

Initial missing values count was `r total_mv_count`.

```{r, out.height="50%", out.width="70%", fig.cap="Counts of missing values by type.", fig.align='center'}
plot_mv_types(params[["dat"]])
```

```{r, results='asis', eval=!is.null(attr(params[["dat"]], "group"))}
lvls_count <- params[["dat"]] %>%
  filter(`sample type` == "Sample") %>%
  select(all_of(attr(params[["dat"]], "group"))) %>%
  summarise(across(attr(params[["dat"]], "group"),
            n_distinct)) %>%
  unlist()
  
cat("## Grouping")
cat("  \n  \nGrouping column is *",
    attr(params[["dat"]], "group"),
    "*. It contains ",
    lvls_count,
    " unique levels.", sep = "")
```

```{r, out.height="50%", out.width = "70%", eval=!is.null(attr(params[["dat"]], "group")), fig.cap="The counts of elements in each level of the selected grouping column.", fig.pos="H", fig.align='center'}
plot_groups(params[["dat"]])
```

## Compounds filtering

```{r, results='asis', eval=params[["filtering_threshold_ex"]]}
cat("Missing values threshold was set to ",
    params[["filtering_threshold"]],
    "%.  \n", sep = "")

LOD_to_remove <- setdiff(get_LOD_to_remove(params[["dat"]],
                                   threshold = params[["filtering_threshold"]]/100),
                         attr(params[["dat"]], "removed"))

if(length(LOD_to_remove) == 0){
 cat("There was no metabolite with missing values ratio above the threshold.  \n") 
}else{
 cat("Metabolites with missing values ratio above the threshold",
     ifelse(is.null(attr(params[["dat"]], "group")),
            ": ",
            " in each level of the group: "),
     paste0(LOD_to_remove, collapse = ", "),
     ".  \n", sep = "")
}
```
```{r, results='asis'}
if(is.null(attr(params[["dat"]], "removed")[["LOD"]])){
  cat("No metabolite was removed based on the missing values ratio.  \n")
}else{
  cat("Metabolites removed based on the missing values ratio: ",
      paste0(attr(params[["dat"]], "removed")[["LOD"]], collapse = ", "),
      ".  \n", sep = "")
}
```

```{r, out.height="40%", out.width="70%", eval=((params[["filtering_threshold_ex"]]) & !is.null(attr(params[["dat"]], "group"))), fig.cap="Venn diagram of metabolites with missing values ratio greater than the threshold in any group level.", fig.pos="H", fig.align='center'}
if(lvls_count < 5)
  create_venn_diagram(params[["dat"]], params[["filtering_threshold"]])
```

```{r, out.height="50%", fig.cap="Missing values ratios in each metabolite (up to 10 metabolites wiht the highest ratios are visible); (a) total ratios; (b) ratios of missing values of each type.", fig.pos="H", fig.align='center'}
NA_perc_plt <- plot_NA_percent(params[["dat"]],
                               interactive = FALSE)

y_levels <- ggplot_build(NA_perc_plt)$layout$panel_params[[1]]$y$breaks
cropped_lvls <- y_levels[(max(length(y_levels)-10, 1)):length(y_levels)]

NA_perc_plt_crop <- NA_perc_plt +
  ylim(cropped_lvls)

NA_perc_type_plt_crop <-
  plot_NA_percent(params[["dat"]],
                  type = "NA_type",
                  interactive = FALSE) +
  ylim(cropped_lvls)

ggarrange(NA_perc_plt_crop, NA_perc_type_plt_crop, ncol = 1, labels = "auto")
```

## Gaps completing

```{r, results='asis'}
if(!is.null(attr(params[["dat"]], "completed"))){
  cat("Data was completed using the following methods:  \n  \n")
  cat("* LOD method: ", params[["LOD_method"]], ",  \n", sep = "")
  cat("* LOD type: ", params[["LOD_type"]], ",  \n", sep = "")
  cat("* LLOQ method: ", params[["LLOQ_method"]], ",  \n", sep = "")
  cat("* ULOQ method: ", params[["ULOQ_method"]], ".  \n", sep = "")
}else{
  cat("Imputation was not performed on the data.")
}
```

```{r, out.height="50%", out.width="80%", fig.cap="Heatmap of missing values for each plate bar code (up to 10 first metabolites from the dataset are visible).", fig.pos="H", fig.align='center'}
aval_pb_codes <- params[["dat"]] %>%
        filter(`sample type` == "Sample") %>%
        select(`plate bar code`) %>%
        unlist() %>%
        unique()

heatmap_plts <- lapply(aval_pb_codes, function(pb_code){
 plot_heatmap(params[["dat"]], pb_code,
              include_title = TRUE) 
})

ggarrange(plotlist = heatmap_plts, ncol = min(length(heatmap_plts), 2))
```

```{r, results="asis", eval=!is.null(attr(params[["dat"]], "completed"))}
cat("The absolute correlation threshold for correlation heatmap was set to ",
    params[["corr_threshold"]]*100,
    "%. There were ",
    length(params[["corr_heatmap_metabolites"]]),
    " metabolites chosen to be visible: ",
    paste0(params[["corr_heatmap_metabolites"]], collapse = ", "),
    ".  \n", sep = "")
```

```{r, eval=!is.null(attr(params[["dat"]], "completed")), out.height="70%", out.width="80%", fig.cap="Correlations heatmap (up to 10 chosen metabolites visible).", fig.align='center', fig.pos="H"}
cor_heatmap <- create_correlations_heatmap(
  params[["dat"]],
  threshold = ifelse(is.null(params[["corr_threshold"]]),
                     0,
                     params[["corr_threshold"]]),
  metabolites_to_display =
    params[["corr_heatmap_metabolites"]][1:min(length(params[["corr_heatmap_metabolites"]]), 10)],
  interactive = FALSE
)

if(!is.null(cor_heatmap)){
 cor_heatmap_cap <- "Correlations heatmap (up to 10 chosen metabolites visible)."
 cor_heatmap_results <- "show"
}else{
 cor_heatmap_cap <- NULL
 cor_heatmap_results <- "asis"
}
```
```{r, eval=!is.null(attr(params[["dat"]], "completed")), out.height="50%", out.width="70%", fig.cap=cor_heatmap_cap, fig.align='center', fig.pos="H", results=ifelse(exists("cor_heatmap_results"), cor_heatmap_results, "show")}
if(is.null(cor_heatmap_cap)){
  cat("No metabolites to show on the heatmap.  \n  \n")
}else
  cor_heatmap
```

```{r, results="asis", eval=!is.null(attr(params[["dat"]], "cv"))}
cat("## Quality control  \n  \n")
cat("CV threshold was set to ",
    params[["cv_threshold"]],
    "%.  \n", sep = "")

CV_to_remove <- setdiff(get_CV_to_remove(params[["dat"]],
                                         threshold = params[["cv_threshold"]]),
                        unlist(attr(params[["dat"]], "removed")))

if(length(CV_to_remove) == 0){
  cat("There were no metabolites with CV greater than the threshold.  \n")
}else{
  cat("Metabolites with CV greater than the threshold: ",
      paste0(CV_to_remove, collapse = ", "),
      ".  \n", sep = "")
}

if(!is.null(attr(params[["dat"]], "removed")[["QC"]])){
  cat("Metabolites removed based on the CV: ",
      paste0(attr(params[["dat"]], "removed")[["QC"]],
             collapse = ", "),
      ".  \n", sep = "")
}else cat("No metabolites were removed based on the CV.  \n")

pca_fig_cap <- paste0("PCA plot",
                      ifelse(is.null(attr(params[["dat"]], "group")),
                             " ",
                             "s "),
                      "with colors indicating",
                      ifelse(is.null(attr(params[["dat"]], "group")),
                             "sample type.",
                             "(a) sample type, (b) group levels."))
```

```{r, eval=!is.null(attr(params[["dat"]], "cv")), out.height="80%", out.width="90%", fig.cap=pca_fig_cap, fig.align='center'}
pca_plt <- create_PCA_plot(
  params[["dat"]],
  type = "sample_type",
  types_to_display = ifelse(is.null(params[["PCA_types"]]),
                            "all",
                            params[["PCA_types"]]),
  interactive = FALSE)
  labels <- NULL

if(!is.null(attr(params[["dat"]], "group"))){
  pca_group_plt <- create_PCA_plot(params[["dat"]], type = "group",
                                   interactive = FALSE)
  pca_plt <- list(pca_plt, pca_group_plt)
  labels <- "auto"
}

ggarrange(plotlist = pca_plt, labels = labels, ncol = 1)
```

```{r, results = "asis", eval=!is.null(attr(params[["dat"]], "cv"))}
if(!is.null(params[["PCA_threshold"]])){
  cat("Biplot threshold was set to ",
    params[["PCA_threshold"]],
    "%.  \n", sep = "")
}

if(!is.null(params[["PCA_variance_threshold"]])){
 cat("The cumulative PCA variance threhold was set to ",
    params[["PCA_variance_threshold"]],
    "%. ", sep = "")
  cat("The maximum number of visible principal components was set to ",
    params[["PCA_variance_max_num"]],
    ".", sep = "") 
}
```

```{r, eval=!is.null(attr(params[["dat"]], "cv")), out.height="90%", out.width="90%", fig.cap="Plots related to PCA; (a) biplot, showing which compounds are similar in terms of the variablity; (b) ratio of variance explained by each principal component.", fig.align='center'}
biplot <- create_PCA_plot(params[["dat"]],
                type = "biplot",
                threshold = params[["PCA_threshold"]]/100,
                types_to_display = params[["PCA_types"]],
                interactive = FALSE)

pca_variance_plt <- pca_variance(params[["dat"]],
             threshold = params[["PCA_variance_threshold"]],
             max_num = params[["PCA_variance_max_num"]],
             cumulative = params[["PCA_variance_cum"]])

ggarrange(biplot, pca_variance_plt, labels = "auto", nrow = 2)
```






